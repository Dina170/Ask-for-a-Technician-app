<!DOCTYPE html>
<html lang="ar" dir="rtl" class="font-[Cairo]">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= blog.blog %> - المدونة</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body,
      p,
      h1,
      h2,
      h3,
      h4,
      h5,
      h6,
      a,
      button,
      input,
      textarea,
      label,
      div {
        font-family: "Cairo", sans-serif !important;
      }
    </style>
  </head>

  <body class="text-gray-800 flex flex-col min-h-screen">
    <!-- header -->
<%- include("../layouts/header", { searchType: searchType }) %>

    <!-- Breadcrumb -->
    <div class="bg-white py-4">
      <div class="mx-4 md:mx-[104px] flex items-center justify-between">
        <div class="flex items-center">
          <a href="/" class="text-[#2A4759] hover:text-[#406A84]">
            <i class="fa-solid fa-home text-2xl ml-3"></i>
          </a>
          <i class="fa-solid fa-chevron-left ml-3 mr-3"></i>
          <span class="font-semibold">المدونة</span>
          <i class="fa-solid fa-chevron-left ml-3 mr-3"></i>
          <span class="font-semibold text-[#B3AFAF]"><%= blog.blog %></span>
        </div>
      </div>
    </div>

    <!-- Title + Desktop Search -->
    <div class="bg-white py-4">
      <div class="mx-4 md:mx-[104px] flex flex-col lg:flex-row items-start lg:items-center justify-between gap-4">
        <div class="text-right">
          <p class="text-[#2A4759] font-bold text-[20px] md:text-[24px] mb-2">
            دليلك الشامل لكل المقالات
          </p>
          <p class="text-[#2A4759] text-[14px] md:text-[16px]">
            اكتشف أحدث المقالات والمحتوى المتعلق بجميع المجالات
          </p>
        </div>

        <!-- Desktop Search -->
        <form action="/posts/search" method="GET" class="hidden lg:flex items-center w-full lg:w-1/3">
          <div class="relative w-full">
            <input
              type="text"
              id="postSearch"
              name="search"
              placeholder="ابحث عن مقال"
              class="w-full border border-gray-300 rounded-[12px] py-2 pr-8 pl-4 focus:outline-none focus:ring-2 focus:ring-[#2A4759]"
            />
            <ul id="postSuggestions" class="absolute z-50 bg-[#FAFAFA] w-full mt-1 rounded-lg hidden"></ul>
            <button type="submit" class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500 hover:text-[#2A4759]">
              <i class="fa-solid fa-magnifying-glass"></i>
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Posts cards -->
    <div class="py-8 flex-grow mx-4 md:mx-[104px]">
      <div id="cards-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        <% if (!posts || posts.length === 0) { %>
        <div class="col-span-3 text-center text-gray-600 bg-white py-10 rounded-lg shadow">
          <i class="fa-solid fa-triangle-exclamation text-orange-400 text-4xl mb-4"></i>
          <p class="text-xl font-semibold mb-2">لا يوجد مقالات بعد</p>
          <p class="text-sm text-gray-500">
            تابع المدونة لاحقًا للمزيد من المحتوى
          </p>
        </div>
        <% } else { %>
    <% posts.forEach(post => {
  const regex = /<img.*?src="(.*?)"/;
  const match = regex.exec(post.content || "");
  const descriptionImage = match ? match[1] : '/uploads/posts/default.png';
  const safeName = (post.name || post.title || "").replace(/"/g, '&quot;');
%>
  <div class="card bg-white border border-gray-200 rounded-lg overflow-hidden shadow-sm relative flex flex-col"
       data-permalink="<%= post.permaLink %>"
       data-name="<%= safeName %>">
    <div class="relative w-full">
      <img
        src="<%= descriptionImage %>"
        alt="<%= post.name %>"
        title="<%= post.name %>"
        class="w-full h-auto object-cover"
      />
    </div>

    <div class="card-body p-4 flex flex-col flex-1">
      <h3 class="text-[18px] font-bold text-[#222222]">
        <%= post.name || post.title %>
      </h3>
      <p class="text-[#5C5C5C] font-normal text-[14px] leading-[200%] mb-5 break-words whitespace-normal overflow-hidden line-clamp-2 md:text-[16px] md:leading-[140%]">
        <%- (post.content || "").replace(/<img.*?>/g,"").replace(/<[^>]+>/g,"").substring(0,200) %>...
      </p>

      <div class="mt-auto flex gap-2">
        <a
          href="/posts/<%= post.permaLink %>"
          class="flex-1 bg-[#2A4759] text-white text-sm text-center h-12 flex items-center justify-center rounded-lg hover:opacity-80 transition-opacity duration-200 mt-2"
        >
          عرض المزيد
        </a>
      </div>
    </div>
  </div>
<% }) %>


        <% } %>
      </div>
    </div>

    <!-- footer -->
    <%- include("../layouts/footer") %>

    <!-- JS Search Autocomplete -->
    <script>
  const input = document.getElementById("postSearch");
  const suggestions = document.getElementById("postSuggestions");
  const cardsContainer = document.getElementById("cards-container");
  let searchTimeout;

  function showAllCards() {
    cardsContainer.querySelectorAll('.card').forEach(c => c.classList.remove('hidden'));
  }

  input.addEventListener('input', () => {
    const q = input.value.trim();
    if (searchTimeout) clearTimeout(searchTimeout);

    if (!q) {
      suggestions.classList.add('hidden');
      suggestions.innerHTML = '';
      showAllCards();
      return;
    }

    searchTimeout = setTimeout(async () => {
      try {
        const res = await fetch(`/posts/autocomplete?q=${encodeURIComponent(q)}`);
        if (!res.ok) throw new Error('خطأ في جلب الاقتراحات');
        const posts = await res.json();

        if (!posts || posts.length === 0) {
          suggestions.innerHTML = "<li class='px-3 py-2 text-gray-500 text-center'>لا توجد نتائج</li>";
          suggestions.classList.remove('hidden');
          return;
        }

        suggestions.innerHTML = posts.map(p => `
          <li class="px-3 py-2 hover:bg-blue-50 cursor-pointer border-b border-gray-100 transition-colors"
              data-permalink="${p.permaLink || ''}"
              data-name="${(p.name || p.title || '').replace(/"/g,'&quot;')}">
            <span class="font-semibold text-gray-800">${(p.name || p.title || '').trim()}</span>
          </li>`).join('');

        suggestions.classList.remove('hidden');

        suggestions.querySelectorAll('li[data-permalink]').forEach(li => {
          li.addEventListener('click', async () => {
            const perma = li.dataset.permalink;
            const name = li.dataset.name;
            input.value = name;
            suggestions.classList.add('hidden');

            const cards = cardsContainer.querySelectorAll('.card');
            let found = false;
            cards.forEach(card => {
              if ((card.dataset.permalink && card.dataset.permalink === perma) ||
                  (card.dataset.name && card.dataset.name === name) ||
                  (card.querySelector('h3') && card.querySelector('h3').innerText.trim() === name)
              ) {
                card.classList.remove('hidden');
                card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                found = true;
              } else {
                card.classList.add('hidden');
              }
            });

            if (!found) {
              try {
                const r = await fetch(`/posts/${encodeURIComponent(perma)}/json`);
                if (r.ok) {
                  const post = await r.json();
                  const image = post.image || '/uploads/posts/default.png';
                  const safeName = (post.name || post.title || '').replace(/"/g,'&quot;');
                  const snippet = (post.content || '').replace(/<[^>]+>/g,'').substring(0,200);
                  cardsContainer.innerHTML = `
                    <div class="card bg-white border border-gray-200 rounded-lg overflow-hidden shadow-sm relative flex flex-col"
                         data-permalink="${post.permaLink}" data-name="${safeName}">
                      <div class="relative w-full">
                        <img src="${image}" alt="${safeName}" class="w-full h-auto object-cover"/>
                      </div>
                      <div class="card-body p-4 flex flex-col flex-1">
                        <h3 class="text-[18px] font-bold text-[#222222]">${safeName}</h3>
                        <p class="text-[#5C5C5C] font-normal text-[14px] leading-[200%] mb-5">${snippet}...</p>
                        <div class="mt-auto flex gap-2">
                          <a href="/posts/${post.permaLink}" class="flex-1 bg-[#2A4759] text-white text-sm text-center h-12 flex items-center justify-center rounded-lg mt-2">عرض المزيد</a>
                        </div>
                      </div>
                    </div>
                  `;
                } else {
                  cardsContainer.innerHTML = `<div class='col-span-3 text-center text-gray-600 bg-white py-10 rounded-lg shadow'>
                    <i class='fa-solid fa-triangle-exclamation text-orange-400 text-4xl mb-4'></i>
                    <p class='text-xl font-semibold mb-2'> لا يوجد مقال بهذا الاسم يمكنك البحث عن مقال اخر</p>
                  </div>`;
                }
              } catch (err) {
                console.error(err);
                cardsContainer.innerHTML = `<div class='col-span-3 text-center text-gray-600 bg-white py-10 rounded-lg shadow'>
                  <i class='fa-solid fa-triangle-exclamation text-orange-400 text-4xl mb-4'></i>
                  <p class='text-xl font-semibold mb-2'>خطأ أثناء جلب المقال</p>
                </div>`;
              }
            }
          });
        });
      } catch (err) {
        console.error(err);
        suggestions.innerHTML = "<li class='px-3 py-2 text-red-500 text-center'>حدث خطأ</li>";
        suggestions.classList.remove('hidden');
      }
    }, 250);
  });

  document.addEventListener('click', (e) => {
    if (!e.target.closest('#postSearch') && !e.target.closest('#postSuggestions')) {
      suggestions.classList.add('hidden');
    }
  });

  const desktopForm = document.querySelector("form[action='/posts/search']");
  if (desktopForm) {
    desktopForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const q = input.value.trim();
      if (!q) { showAllCards(); return; }
      const cards = cardsContainer.querySelectorAll('.card');
      let foundAny = false;
      cards.forEach(card => {
        if ((card.dataset.name && card.dataset.name.includes(q)) ||
            (card.dataset.permalink && card.dataset.permalink === q) ||
            (card.querySelector('h3') && card.querySelector('h3').innerText.includes(q))
        ) {
          card.classList.remove('hidden');
          foundAny = true;
          card.scrollIntoView({ behavior: 'smooth', block: 'center' });
        } else {
          card.classList.add('hidden');
        }
      });
      if (!foundAny) {
  const cards = cardsContainer.querySelectorAll('.card');
  cards.forEach(c => c.classList.add('hidden'));

  const msg = document.createElement('div');
  msg.id = "noResultsMsg";
  msg.className = "col-span-3 text-center text-gray-600 bg-white py-10 animate-fade";
  msg.innerHTML = `
      <i class="fa-solid fa-circle-exclamation text-3xl mb-3 text-[#2A4759]"></i>
    <p class='text-lg font-semibold mb-2'>لا توجد مقالات تطابق "${q}"</p>
  </div>
  `;
  cardsContainer.appendChild(msg);

  setTimeout(() => {
    msg.remove();
    showAllCards();
  }, 2000);
}

    });
  }

const postTitle = '<%= posts && posts[0] ? posts[0].name : "مقال" %>';
        const allImages = document.querySelectorAll('img');
        
        allImages.forEach(function(img) {
          if (!img.alt || img.alt.trim() === '' || img.alt === 'N/A') {
            img.alt = postTitle;
          }
          if (!img.title || img.title.trim() === '' || img.title === 'N/A') {
            img.title = postTitle;
          }
        });
</script>
<!-- Floating Contact Buttons -->
<div
  class="fixed right-4 bottom-4 flex flex-col gap-3 z-50"
>
  <!-- Phone -->
  <a
    href="tel:<%= mainPhone %>"
    class="bg-[#2A4759] hover:bg-[#1e3542] text-white p-3 sm:p-4 rounded-full shadow-md shadow-white/30 transition transform hover:scale-110 flex items-center justify-center w-12 h-12 sm:w-14 sm:h-14"
  >
    <i class="fa-solid fa-phone text-base sm:text-lg"></i>
  </a>

  <!-- WhatsApp -->
  <a
    href="https://wa.me/<%= mainPhone %>"
    target="_blank"
    class="bg-green-500 hover:bg-green-600 text-white p-3 sm:p-4 rounded-full  transition transform hover:scale-110 flex items-center justify-center w-12 h-12 sm:w-14 sm:h-14"
  >
    <i class="fab fa-whatsapp text-lg sm:text-xl"></i>
  </a>
</div>
  </body>
</html>
