<!DOCTYPE html>
<html lang="ar" dir="rtl" class="font-[Cairo]">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= blog.blog %> - المدونة</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body,
      p,
      h1,
      h2,
      h3,
      h4,
      h5,
      h6,
      a,
      button,
      input,
      textarea,
      label,
      div {
        font-family: "Cairo", sans-serif !important;
      }
    </style>
  </head>

  <body class="text-gray-800 flex flex-col min-h-screen">
    <!-- header -->
    <%- include("../layouts/header") %>

    <!-- Breadcrumb -->
    <div class="bg-white border-b border-gray-200 py-4">
      <div
        class="max-w-8xl px-4 md:px-32 mx-auto flex items-center justify-between"
      >
        <div class="flex items-center">
          <a href="/" class="text-[#2A4759] hover:text-[#406A84]">
            <i class="fa-solid fa-home text-2xl ml-3"></i>
          </a>
          <i class="fa-solid fa-chevron-left ml-3 mr-3"></i>
          <span class="font-semibold">المدونة</span>
          <i class="fa-solid fa-chevron-left ml-3 mr-3"></i>
          <span class="font-semibold text-[#B3AFAF]"><%= blog.blog %></span>
        </div>
      </div>
    </div>

    <!-- Title + Desktop Search -->
    <div class="bg-white py-4">
      <div
        class="max-w-8xl mx-auto px-4 md:px-32 flex flex-col lg:flex-row items-start lg:items-center justify-between gap-4"
      >
        <div class="text-right">
          <p class="text-[#2A4759] font-bold text-[20px] md:text-[24px] mb-2">
            دليلك الشامل لكل المقالات
          </p>
          <p class="text-[#2A4759] text-[14px] md:text-[16px]">
            اكتشف أحدث المقالات والمحتوى المتعلق بجميع المجالات
          </p>
        </div>

        <!-- Desktop Search -->
        <form
          action="/posts/search"
          method="GET"
          class="hidden lg:flex items-center w-full lg:w-1/3"
        >
          <div class="relative w-full">
            <input
              type="text"
              id="postSearch"
              name="search"
              placeholder="ابحث عن مقال"
              class="w-full border border-gray-300 rounded-[12px] py-2 pr-8 pl-4 focus:outline-none focus:ring-2 focus:ring-[#2A4759]"
            />
            <ul
              id="postSuggestions"
              class="absolute z-50 bg-[#FAFAFA] w-full mt-1 rounded-lg hidden"
            ></ul>
            <button
              type="submit"
              class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500 hover:text-[#2A4759]"
            >
              <i class="fa-solid fa-magnifying-glass"></i>
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Posts cards -->
    <div
      class="container mx-auto px-4 sm:px-4 lg:px-12 py-8 flex-grow"
    >
      <div
        id="cards-container"
        class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"
      >
        <% if (!posts || posts.length === 0) { %>
        <div
          class="col-span-3 text-center text-gray-600 bg-white py-10 rounded-lg shadow"
        >
          <i
            class="fa-solid fa-triangle-exclamation text-orange-400 text-4xl mb-4"
          ></i>
          <p class="text-xl font-semibold mb-2">لا يوجد مقالات بعد</p>
          <p class="text-sm text-gray-500">
            تابع المدونة لاحقًا للمزيد من المحتوى
          </p>
        </div>
        <% } else { %> <% posts.forEach(post => {
        const regex = /<img.*?src="(.*?)"/; const match =
        regex.exec(post.content || ""); const descriptionImage = match ?
        match[1] : '/uploads/posts/default.png'; %>
        <div
          class="card bg-white border border-gray-200 rounded-lg overflow-hidden shadow-sm relative flex flex-col"
        >
          <div class="relative h-48">
            <img
              src="<%= descriptionImage %>"
              alt="<%= post.title || post.name %>"
              class="w-full h-full object-cover"
            />
          </div>
          <div class="card-body p-4 flex flex-col flex-1">
            <h3 class="text-lg font-bold text-[#222222] ">
              <%= post.name || post.title %>
            </h3>
            <p
              class="text-gray-700 text-sm mb-3 line-clamp-2 overflow-hidden"
            >
              <%- post.content.replace(/<img.*?>/g,
              "").substring(0,200) %>...
            </p>
            <div class="mt-auto flex gap-2">
              <a
                href="/posts/<%= post.permaLink %>"
                class="flex-1 bg-[#2A4759] text-white text-sm text-center h-12 flex items-center justify-center rounded-lg hover:opacity-80 transition-opacity duration-200 mt-2"
              >
                عرض المزيد
              </a>
            </div>
          </div>
        </div>
        <% }) %> <% } %>
      </div>
    </div>

    <!-- footer -->
    <%- include("../layouts/footer") %>

    <!-- JS Search Autocomplete -->
    <script>
      const input = document.getElementById("postSearch");
      const suggestions = document.getElementById("postSuggestions");
      const cardsContainer = document.getElementById("cards-container");

      let searchTimeout;

      input.addEventListener("input", () => {
        const query = input.value.trim();

        if (searchTimeout) clearTimeout(searchTimeout);

        if (!query || query.length < 2) {
          suggestions.innerHTML = "";
          suggestions.classList.add("hidden");
          return;
        }

        searchTimeout = setTimeout(async () => {
          try {
            const res = await fetch(
              `/posts/autocomplete?q=${encodeURIComponent(query)}`
            );
            if (!res.ok) throw new Error("خطأ في جلب البيانات");

            const posts = await res.json();

            if (posts.length === 0) {
              suggestions.innerHTML =
                "<li class='px-3 py-2 text-gray-500 text-center'>لا توجد نتائج</li>";
              suggestions.classList.remove("hidden");
              return;
            }

            suggestions.innerHTML = posts
              .map(
                (p) => `
                <li class="px-3 py-2 hover:bg-blue-50 cursor-pointer border-b border-gray-100 transition-colors" 
                    data-link="/posts/${p.permaLink}">
                  <div class="flex flex-col">
                    ${
                      p.title
                        ? `<span class="font-semibold text-gray-800">${p.title}</span>`
                        : ""
                    }
                    ${
                      p.name
                        ? `<span class="text-sm text-gray-600">${p.name}</span>`
                        : ""
                    }
                  </div>
                </li>`
              )
              .join("");

            suggestions.classList.remove("hidden");

            suggestions.querySelectorAll("li[data-link]").forEach((li) => {
              li.addEventListener("click", () => {
                window.location.href = li.dataset.link;
              });
            });
          } catch (err) {
            console.error(err);
            suggestions.innerHTML =
              "<li class='px-3 py-2 text-red-500 text-center'>حدث خطأ</li>";
            suggestions.classList.remove("hidden");
          }
        }, 300);
      });

      document.addEventListener("click", (e) => {
        if (
          !e.target.closest("#postSearch") &&
          !e.target.closest("#postSuggestions")
        ) {
          suggestions.classList.add("hidden");
        }
      });
    </script>
  </body>
</html>
