<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>اطلب فني</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    body,
    p,
    span,
    h1,
    h2,
    h3,
    h4,
    h5,
    h6,
    a,
    button,
    input,
    textarea,
    label,
    div {
      font-family: "Cairo", sans-serif !important;
    }

    .line-clamp-1 {
      display: -webkit-box;
      -webkit-line-clamp: 1;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .line-clamp-3 {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    select {
      background-image: none;
    }

    select::-ms-expand {
      display: none;
    }

    select:focus {
      outline: none;
    }

    /* Adjust chevron for RTL */
    .relative select+.fa-chevron-down {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
      color: #6b7280;
    }

    .relative select+.fa-chevron-down {
      display: none !important;
    }


   @media (max-width: 360px) {
    .search-form .input-box,
    .search-form button {
      min-height: 32px !important;
      font-size: 12px !important;
      padding: 4px 8px !important;
    }
    .search-form select {
      font-size: 12px !important;
    }
  }

    @media (max-width: 360px) {
  .action-buttons {
    margin-top: 1rem !important; 
  }
}



      @media (max-width: 640px) {
        .line-clamp-mobile {
          display: -webkit-box;
          -webkit-line-clamp: 3;
          -webkit-box-orient: vertical;
          overflow: hidden;
        }
      }

      @keyframes fadeIn {
  from { opacity: 0; transform: translateY(-5px); }
  to { opacity: 1; transform: translateY(0); }
}

.animate-fade-in {
  animation: fadeIn 0.5s ease-in-out;
}

    </style>
  </head>

<body class="font-sans text-gray-800 flex flex-col min-h-screen">
  <%- include("../layouts/header", { searchType: searchType }) %>


    <main class="flex-1">
      <!-- Hero Section -->
      <section class="relative w-full h-[300px] sm:h-[350px] md:h-[400px] lg:h-[450px]">
        <div class="absolute inset-0 z-0">
          <img src="/images/hero.png" alt="hero" class="w-full h-full object-cover" />
          <div class="absolute inset-0 bg-black bg-opacity-30"></div>
        </div>

        <div class="relative z-20 flex flex-col justify-center h-full px-4 lg:px-[104px] w-full">
          <!-- Hero Content -->
          <p
            class="font-[Cairo] font-bold text-[24px] sm:text-[36px] leading-[100%] tracking-[0] text-white text-center sm:text-right mb-6">
            أعثر علي الفني المناسب لك
          </p>

          <p class="font-[Cairo] font-medium text-[18px] leading-[160%] text-white text-center  sm:text-right mb-6">
            استكشف أفضل العمال المهرة بسهولة وسرعة، سواء كنت تبحث عن كهربائي، نجار، سباك، أو أي خدمة أخرى — كل ما تحتاجه
            في مكان واحد
          </p>

    <!-- Action Buttons -->
<div class="flex flex-row gap-2 sm:gap-4 items-center justify-center md:justify-start mt-6 sm:mt-8 md:mt-10 lg:mt-12 -translate-y-6 sm:translate-y-0 transition-transform duration-300">
  <a href="https://wa.me/<%= mainPhone %>" target="_blank" 
     class="flex items-center justify-center gap-1.5 bg-white hover:bg-[#2A4759] hover:text-white text-[#2A4759] text-xs sm:text-sm rounded-[10px] sm:rounded-[12px] px-4 sm:px-[30px] py-2 sm:py-3 w-[163px] sm:w-[272.25px] h-[38px] sm:h-[56px] transition-all duration-300 shadow-md">
    <i class="fab fa-whatsapp text-lg sm:text-xl"></i>
    <span class="whitespace-nowrap">ارسال على واتساب</span>
  </a>

            <a href="tel:<%= mainPhone %>"
              class="flex items-center justify-center gap-1.5 border border-white hover:border-[#2A4759] hover:bg-[#2A4759] hover:text-white text-white text-xs sm:text-sm rounded-[10px] sm:rounded-[12px] px-4 sm:px-[30px] py-2 sm:py-3 w-[163px] sm:w-[272.25px] h-[38px] sm:h-[56px] transition-all duration-300">
              <i class="fa-solid fa-phone text-lg sm:text-xl"></i>
              <span class="whitespace-nowrap">اتصل الآن</span>
            </a>
          </div>

        </div>
      </section>

<section class="relative -mt-6 sm:-mt-8 md:-mt-12 lg:-mt-10 z-30 px-0 lg:px-[104px]">
    <div class="max-w-4xl mx-auto">
   

    <form id="searchForm" method="get" action="/" 
      class="bg-white shadow-xl rounded-xl p-2 sm:p-3 md:p-4 mx-4 sm:mx-0">

      <div class="flex flex-row items-stretch gap-2 sm:gap-3 md:gap-4 w-full">
  <!-- Technician Select -->
  <div class="flex-1">
    <div class="flex items-center border border-gray-300 rounded-lg px-2 sm:px-3 bg-gray-50 h-[36px] sm:h-[40px]
">
      <i class="fa-solid fa-user text-gray-500 ml-2 text-xs sm:text-sm md:text-base"></i>
      <select id="technicianSelect" name="jobId"
        class="w-full outline-none text-xs sm:text-sm md:text-base bg-transparent cursor-pointer h-full">
        <option value="">اختر الفني</option>
        <% jobs.forEach(job => { 
          const jobValue = job.jobId || job._id;
          const jobName = job._id && typeof job._id === 'string' ? job._id : job.name;
        %>
          <option 
            value="<%= jobValue %>" 
            <%= typeof selectedJobId !== 'undefined' && selectedJobId == jobValue.toString() ? 'selected' : '' %>>
            <%= jobName %>
          </option>
        <% }) %>
      </select>
      <i class="fa-solid fa-chevron-down text-gray-500 mr-2 pointer-events-none text-xs sm:text-sm md:text-base"></i>
    </div>
  </div>

  <!-- Neighborhood Select -->
  <div class="flex-1">
    <div class="flex items-center border border-gray-300 rounded-lg px-2 sm:px-3 bg-gray-50 h-[36px] sm:h-[40px]
">
      <i class="fa-solid fa-location-dot text-gray-500 ml-2 text-xs sm:text-sm md:text-base"></i>
      <select id="neighborhoodSelect" name="neighborhood"
        class="w-full outline-none text-xs sm:text-sm md:text-base bg-transparent cursor-pointer h-full">
        <option value="">اختر الحي</option>
        <% if (typeof uniqueNeighborhoods !== 'undefined') { %>
          <% uniqueNeighborhoods.forEach(hood => { %>
            <option value="<%= hood.name %>" <%= neighborhood === hood.name ? 'selected' : '' %>>
              <%= hood.name %>
            </option>
          <% }) %>
        <% } %>
      </select>
      <i class="fa-solid fa-chevron-down text-gray-500 mr-2 pointer-events-none text-xs sm:text-sm md:text-base"></i>
    </div>
  </div>

  <!-- Search Button -->
  <div class="flex">
    <button type="submit"
      class="bg-gradient-to-r from-orange-400 to-orange-600 text-white px-4 sm:px-6 md:px-8 rounded-lg font-medium whitespace-nowrap flex items-center justify-center shadow-md appearance-none h-[36px] sm:h-[40px]
 text-sm sm:text-base">
      بحث
    </button>
  </div>
</div>

    </form>

    
  </div>
   <!-- حتة لعرض رسالة لو مفيش فني -->
    <div id="searchMessageContainer" class="max-w-lg mx-auto mt-4 text-center"></div>
</section>




      <div class="h-6 sm:h-12 md:h-16"></div>

      <!-- Technicians Cards -->
      <div id="cards-container" class="mx-4 lg:mx-[104px]">
        <div class="w-full text-right mb-8">
          <p class="text-[#2A4759] font-bold text-[20px] md:text-[24px] mb-2"> الفنيون المتاحون الآن في مدينة الرياض</p>
          <p class="text-[#2A4759] text-[14px] md:text-[16px]">فنيونا متواجدون حاليًا في مناطق متعددة داخل مدينة الرياض،
            ونسعد دائمًا بخدمتكم</p>
        </div>

        <% if (typeof message !== 'undefined' && message) { %>
  <div class="col-span-full text-center bg-yellow-50 border border-orange-400 text-gray-600 px-6 py-8 rounded-xl shadow-md mb-6">
              <i class="fa-solid fa-triangle-exclamation text-orange-400 text-4xl mb-4"></i>
    <p class="text-lg font-semibold mb-2"><%= message %></p>
    <p class="text-sm text-gray-500">يمكنك تجربة مهنة أو حي مختلف من القائمة أعلاه.</p>
  </div>
<% } %>


        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
          <%  if (typeof technicians !== 'undefined') { %>
            <% technicians.forEach(technician => { %>
              <div class="card bg-white border border-gray-200 rounded-xl overflow-hidden shadow-sm duration-300 flex flex-col">
                <div class="relative h-48 sm:h-52 md:h-48 overflow-hidden">
                  <img src="<%= technician.jobTechnicianPhoto %>" alt="<%= technician.jobName.name %>" title="<%= technician.jobName.name %>"  class="w-full h-full object-cover hover:scale-105 transition-transform duration-300" />
                  <div class="absolute inset-0 bg-gradient-to-t from-black/20 to-transparent"></div>
                </div>
                <div class="card-body p-4 sm:p-5 flex flex-col flex-1">
                  <h3 class="tech-name text-[18px] font-bold text-[#222222] mb-2"><%= technician.jobName.name %></h3>
                  <p class="text-[#5C5C5C] font-normal text-[14px] leading-[200%] mb-5 break-words whitespace-normal overflow-hidden line-clamp-2 md:text-[16px] md:leading-[140%]"><%- technician.mainTitle.replace(/<img.*?>/g, "").replace(/<[^>]+>/g, "").substring(0, 200) %>...</p>
                  <div class="mt-auto">
                    <a href="/technicians/<%= technician.slug %>" class="block w-full bg-[#2A4759] hover:bg-[#1e3542] text-white text-sm sm:text-base text-center py-3 px-4 rounded-lg transition-colors duration-300 font-medium">عرض المزيد</a>
                  </div>
                </div>
              </div>
            <% }) %>
          <% } %>
        </div>
      </div>



      <div class="h-8 sm:h-12"></div>
    </main>

    <%- include('../layouts/footer') %>

 <script>
  // Job filter buttons
  document.querySelectorAll(".job-filter-btn").forEach(button => {
    button.addEventListener("click", async function () {
      const technicianId = this.dataset.technicianId;
      try {
        const response = await fetch(`/technicians/${technicianId}/neighborhoods`);
        const html = await response.text();
        document.getElementById("cards-container").innerHTML = html;

        const loadMoreContainer = document.querySelector(".text-center.mt-8");
        if (loadMoreContainer) {
          loadMoreContainer.innerHTML = `<a href="/technicians/${technicianId}/seeMoreTechnicianNeighborhoods" class="inline-block bg-white hover:bg-[#2A4759] hover:text-white text-[#2A4759] border-2 border-[#2A4759] px-6 sm:px-8 py-3 rounded-lg shadow-md hover:shadow-lg transition-all duration-300 font-medium">عرض المزيد <i class="fa-solid fa-chevron-left mr-2"></i></a>`;
        }
      } catch (err) {
        console.error("Error loading neighborhoods:", err);
      }
    });
  });

  // Smooth scroll for anchors
  document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener("click", function (e) {
      e.preventDefault();
      const target = document.querySelector(this.getAttribute("href"));
      if (target) {
        target.scrollIntoView({ behavior: "smooth", block: "start" });
      }
    });
  });

  // Custom select styling + redirect logic
  document.addEventListener("DOMContentLoaded", function () {
    const selectElements = document.querySelectorAll("select");
    selectElements.forEach(select => {
      select.addEventListener("focus", function () {
        this.parentElement.style.borderColor = "#2A4759";
        this.parentElement.style.boxShadow = "0 0 0 3px rgba(42, 71, 89, 0.1)";
      });
      select.addEventListener("blur", function () {
        this.parentElement.style.borderColor = "#d1d5db";
        this.parentElement.style.boxShadow = "none";
      });
    });

    // Redirect to technician details after search
   // Redirect to technician details after search
   const searchForm = document.getElementById("searchForm");
  const messageContainer = document.getElementById("searchMessageContainer");

  searchForm.addEventListener("submit", async function (e) {
    e.preventDefault();

    // مسح أي رسالة قديمة
    messageContainer.innerHTML = "";

    const jobSelect = document.getElementById("technicianSelect");
    const neighborhoodSelect = document.getElementById("neighborhoodSelect");

    const selectedJobId = jobSelect.value;
    const selectedNeighborhood = neighborhoodSelect.value;

    // لو مفيش مهنة مختارة نخلي الفورم يعمل submit عادي (أو تنبيه)
     if (!selectedJobId) {
    const warnDiv = document.createElement("div");
    warnDiv.className =
      "bg-yellow-50 border border-yellow-300 text-gray-700 px-6 py-5 rounded-xl shadow-md max-w-lg mx-auto animate-fade-in";
    warnDiv.innerHTML = `
      <div class="flex flex-col items-center text-center">
        <i class="fa-solid fa-circle-exclamation text-orange-500 text-3xl mb-2"></i>
        <p class="font-semibold mb-1">من فضلك اختر المهنة أولاً</p>
        <p class="text-sm text-gray-600">حدد المهنة قبل البدء في البحث.</p>
      </div>`;
    messageContainer.appendChild(warnDiv);

    // تختفي بعد 4 ثواني
    setTimeout(() => {
      warnDiv.classList.add("opacity-0", "transition-opacity", "duration-500");
      setTimeout(() => warnDiv.remove(), 500);
    }, 4000);
    return;
  }

    try {
  const resp = await fetch(
    `/technicians/api/get-technician-slug?jobId=${encodeURIComponent(selectedJobId)}&neighborhood=${encodeURIComponent(selectedNeighborhood || "")}`
  );

  const data = await resp.json();

  // لو وجدنا فني
  if (data.slug) {
    window.location.href = `/technicians/${encodeURIComponent(data.slug)}`;
    return;
  }

  // تحديد نوع الرسالة بناءً على البيانات الراجعة من السيرفر
  let messageHTML = "";
  let icon = "";
  let bgColor = "";
  let borderColor = "";

  if (data.jobExists && !data.neighborhoodExists) {
    // مهنة موجودة لكن الحي مش متاح
    icon = `<i class="fa-solid fa-location-dot text-orange-500 text-3xl mb-2"></i>`;
    messageHTML = `
      <p class="font-semibold mb-1">لا يوجد فني في هذا الحي حالياً</p>
      <p class="text-sm text-gray-600">جرب حي آخر لهذه المهنة.</p>
    `;
    bgColor = "bg-yellow-50";
    borderColor = "border-yellow-300";
  } else if(!data.jobExists) {
    // لا يوجد فنيون نهائياً لهذه المهنة
    icon = `<i class="fa-solid fa-triangle-exclamation text-orange-500 text-3xl mb-2"></i>`;
    messageHTML = `
      <p class="font-semibold mb-1">عذراً، لا يوجد فنيون متاحون لهذه المهنة حالياً</p>
      <p class="text-sm text-gray-600">يمكنك اختيار مهنة مختلفة من القائمة أعلاه.</p>
    `;
    bgColor = "bg-yellow-50";
    borderColor = "border-orange-300";
  }

  // إنشاء الرسالة
  const noResultDiv = document.createElement("div");
noResultDiv.className = `${bgColor} ${borderColor} border text-gray-700 px-6 py-5 rounded-xl shadow-md max-w-lg mx-auto animate-fade-in mx-5 sm:mx-auto`;
  noResultDiv.innerHTML = `<div class="flex flex-col items-center text-center">${icon}${messageHTML}</div>`;
  messageContainer.appendChild(noResultDiv);

  // اختفاء تلقائي بعد 5 ثواني
  setTimeout(() => {
    noResultDiv.classList.add("opacity-0", "transition-opacity", "duration-500");
    setTimeout(() => noResultDiv.remove(), 500);
  }, 4000);

} catch (err) {
  console.error("Error fetching slug:", err);

  const errDiv = document.createElement("div");
  errDiv.className =
    "bg-red-50 border border-red-300 text-red-700 px-6 py-5 rounded-xl shadow-md max-w-lg mx-auto animate-fade-in";
  errDiv.innerHTML = `
    <div class="flex flex-col items-center text-center">
      <i class="fa-solid fa-circle-xmark text-red-500 text-3xl mb-2"></i>
      <p class="font-semibold mb-1">حدث خطأ أثناء البحث</p>
      <p class="text-sm text-gray-600">يرجى المحاولة لاحقاً.</p>
    </div>`;
  messageContainer.appendChild(errDiv);

  setTimeout(() => {
    errDiv.classList.add("opacity-0", "transition-opacity", "duration-500");
    setTimeout(() => errDiv.remove(), 500);
  }, 4000);
}

  });

const firstTechnicianTitle = '<%= technicians[0] ? technicians[0].mainTitle : "" %>';
      const allImages = document.querySelectorAll('img');
      
     allImages.forEach(function(img) {
  if (!img.alt || img.alt.trim() === '' || img.alt === 'N/A') {
    img.alt = firstTechnicianTitle;
  }
  if (!img.title || img.title.trim() === '' || img.title === 'N/A') {
    img.title = firstTechnicianTitle;
  }
});



const technicianTitle = '<%= technicians[0] ? technicians[0].mainTitle : "" %>';
      const allImages = document.querySelectorAll('img');
      
      allImages.forEach(function(img) {
        if (!img.alt || img.alt.trim() === '' || img.alt === 'N/A') {
          img.alt = technicianTitle;
        }
        if (!img.title || img.title.trim() === '' || img.title === 'N/A') {
          img.title = technicianTitle;
        }
      });

  });
</script>


   

<!-- Floating Contact Buttons -->
<!-- Floating Contact Buttons -->
<div
  class="fixed right-4 bottom-4 flex flex-col gap-3 z-50"
>
  <!-- Phone -->
  <a
    href="tel:<%= mainPhone %>"
    class="bg-[#2A4759] hover:bg-[#1e3542] text-white p-3 sm:p-4 rounded-full shadow-md shadow-white/30 transition transform hover:scale-110 flex items-center justify-center w-12 h-12 sm:w-14 sm:h-14"
  >
    <i class="fa-solid fa-phone text-base sm:text-lg"></i>
  </a>

  <!-- WhatsApp -->
  <a
    href="https://wa.me/<%= mainPhone %>"
    target="_blank"
    class="bg-green-500 hover:bg-green-600 text-white p-3 sm:p-4 rounded-full  transition transform hover:scale-110 flex items-center justify-center w-12 h-12 sm:w-14 sm:h-14"
  >
    <i class="fab fa-whatsapp text-lg sm:text-xl"></i>
  </a>
</div>


  </body>
</html>