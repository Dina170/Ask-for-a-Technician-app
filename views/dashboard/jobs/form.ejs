<% if (typeof error !== 'undefined' && error) { %>
  <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
    <strong class="font-bold">خطأ:</strong>
    <span class="block sm:inline"><%= error %></span>
  </div>
<% } %>

<div class="rounded-tl-3xl shadow-md border p-5 h-[100%] bg-white">
  <div class="mb-6 px-6">
    <h1 class="text-xl font-bold my-1 text-right"><%= job ? "تعديل وظيفة" : "إضافة وظيفة" %></h1>
    <p class="text-gray-600 text-right"><a href="/dashboard/jobs" class="hover:text-Sky-950 hover:font-medium">الوظائف</a> &gt; <%= job ? "تعديل وظيفة" : "إضافة وظيفة" %></p>
  </div>

  <form action="<%= job ? '/dashboard/jobs/' + job._id + '?_method=PUT' : '/dashboard/jobs' %>" method="POST" enctype="multipart/form-data" onsubmit="handleSubmit()">
    <div class="bg-white rounded-lg px-6 py-2">

      <!-- Job Name -->
      <div class="mb-6">
        <label class="block text-right mb-2 required font-medium">اسم الوظيفة</label>
        <input type="text" name="name" required
               class="w-full p-2 border rounded-md text-right focus:outline-blue-950 focus:outline-1"
               placeholder="ادخل اسم الوظيفة"
               value="<%= job?.name || '' %>">
      </div>

      <!-- Neighborhood Selection -->
      <div class="mb-6">
        <label class="block text-right mb-2 required font-medium">الحي</label>
        <select name="neighborhoodName" required
                class="w-full p-2 border rounded-md text-right focus:outline-blue-950 focus:outline-1">
          <% neighborhoods.forEach(n => { %>
            <option value="<%= n._id %>" <%= job && job.neighborhoodName?.equals(n._id) ? 'selected' : '' %>><%= n.name %></option>
          <% }) %>
        </select>
      </div>

      <!-- Image Upload -->
      <div class="mb-6">
        <label class="block text-right mb-2 required font-medium">صورة الوظيفة</label>

        <% if (job && job.jobPhoto) { %>
          <!-- EDIT MODE -->
          <div id="editPreview" class="px-4 w-full h-10 rounded-md flex items-center relative border mb-2">
            <img src="/uploads/jobs/<%= job.jobPhoto %>" 
                 class="w-8 h-8 object-cover rounded-md border" 
                 id="editImg">
            <span class="absolute top-0 left-0 bg-white w-10 h-9 text-red-500 rounded-full p-1 text-xs cursor-pointer flex justify-center z-40 items-center"
                  onclick="
                    document.getElementById('editPreview').classList.add('hidden');
                    document.getElementById('uploadInputEdit').classList.remove('hidden');
                    document.getElementById('fileInputEdit').value = '';
                  ">
              <i class="fa-solid fa-trash"></i>
            </span>
          </div>
          <div id="uploadInputEdit" class="hidden flex border rounded-lg mb-2">
            <div class="px-4 w-full h-10 flex items-center">
              <label for="fileInputEdit" class="cursor-pointer w-full flex items-center justify-between">
                <i class="fa-solid fa-cloud-arrow-up text-gray-500"></i>
                <span class="text-gray-800 border rounded-md px-1 py-0.5 border-gray-800 text-xs hover:bg-gray-700 hover:text-white">حدد الملف</span>
              </label>
              <input type="file" name="jobPhoto" id="fileInputEdit" class="hidden">
            </div>
          </div>
        <% } else { %>
          <!-- ADD MODE -->
          <div id="addPreview" class="relative hidden w-32 h-32 border border-gray-300 rounded-md bg-gray-100 mb-4"></div>
          <div id="uploadInputAdd" class="flex border rounded-lg mb-2">
            <div class="px-4 w-full h-10 flex items-center">
              <label for="fileInputAdd" class="cursor-pointer w-full flex items-center justify-between">
                <i class="fa-solid fa-cloud-arrow-up text-gray-500"></i>
                <span class="text-gray-800 border rounded-md px-1 py-0.5 border-gray-800 text-xs hover:bg-gray-700 hover:text-white">حدد الملف</span>
              </label>
              <input type="file" name="jobPhoto" id="fileInputAdd" class="hidden" <%= job ? '' : 'required' %>>
            </div>
          </div>
        <% } %>
      </div>

      <!-- Main Description -->
      <div class="mb-6">
        <label class="block text-right mb-2 font-medium">الوصف الرئيسي</label>
        <div id="mainEditor" class="quill-container border rounded-md"></div>
        <input type="hidden" name="mainDescription" id="mainDescription" />
      </div>

      <!-- Sub Description -->
      <div class="mb-6">
        <label class="block text-right mb-2 font-medium">الوصف الفرعي</label>
        <div id="subEditor" class="quill-container border rounded-md"></div>
        <input type="hidden" name="subDescription" id="subDescription" />
      </div>

      <!-- Buttons -->
      <div class="flex justify-between mt-10">
        <button type="submit" class="bg-gray-400 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-md w-[45%] text-center flex items-center justify-center">
          <i class="fa-regular fa-square-check me-2"></i><%= job ? "تحديث" : "حفظ" %>
        </button>
        <a href="/dashboard/jobs" class="bg-white border border-gray-700 hover:bg-gray-700 hover:text-white text-gray-800 font-bold py-3 px-4 rounded-md flex items-center justify-center w-[45%]">
          رجوع <i class="fa-solid fa-arrow-left ms-2"></i>
        </a>
      </div>

    </div>
  </form>
</div>

<!-- Quill CSS & JS -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet" />
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

<script>
  const toolbarOptions = [
    ['bold', 'italic', 'underline'],
    [{ 'color': [] }, { 'background': [] }],
    [{ align: [] }],
    [{ list: 'ordered' }, { list: 'bullet' }],
    [{ 'direction': 'rtl' }],
    ['clean']
  ];

  const mainEditor = new Quill('#mainEditor', {
    theme: 'snow',
    modules: { toolbar: toolbarOptions }
  });

  const subEditor = new Quill('#subEditor', {
    theme: 'snow',
    modules: { toolbar: toolbarOptions }
  });

  <% if (job) { %>
    mainEditor.root.innerHTML = <%- JSON.stringify(job.mainDescription) %>;
    subEditor.root.innerHTML = <%- JSON.stringify(job.subDescription) %>;
  <% } %>

  function handleSubmit() {
    document.getElementById('mainDescription').value = mainEditor.root.innerHTML;
    document.getElementById('subDescription').value = subEditor.root.innerHTML;
  }

  // Image Preview Logic
  const isEdit = <%= job ? 'true' : 'false' %>;
  const fileInputId = isEdit ? 'fileInputEdit' : 'fileInputAdd';
  const uploadDivId = isEdit ? 'uploadInputEdit' : 'uploadInputAdd';
  const previewDivId = isEdit ? 'editPreview' : 'addPreview';

  const fileInput = document.getElementById(fileInputId);
  document.getElementById('neighborhoodForm').addEventListener('submit', function (e) {
  if (!isEdit && !fileInput.files.length) {
    e.preventDefault();
    document.getElementById('photoError').textContent = 'الرجاء رفع صورة الحي';
  }
});
  if (fileInput) {
    fileInput.addEventListener('change', function (e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = event => {
        const preview = document.getElementById(previewDivId);
        if (isEdit) {
          preview.querySelector('img').src = event.target.result;
          preview.classList.remove('hidden');
          document.getElementById(uploadDivId).classList.add('hidden');
        } else {
          const img = document.createElement('img');
          img.src = event.target.result;
          img.className = 'w-full h-full object-cover rounded-md';

          const deleteIcon = document.createElement('span');
          deleteIcon.innerHTML = '&times;';
          deleteIcon.className = 'absolute top-1.5 right-1 bg-gray-100 font-medium w-5 h-5 text-gray-700 rounded-full flex justify-center items-center cursor-pointer text-lg';
          deleteIcon.onclick = () => {
            preview.innerHTML = '';
            preview.classList.add('hidden');
            document.getElementById(uploadDivId).classList.remove('hidden');
            fileInput.value = '';
          };

          preview.innerHTML = '';
          preview.appendChild(img);
          preview.appendChild(deleteIcon);
          preview.classList.remove('hidden');
          document.getElementById(uploadDivId).classList.add('hidden');
        }
      };
      reader.readAsDataURL(file);
    });
  }
</script>
