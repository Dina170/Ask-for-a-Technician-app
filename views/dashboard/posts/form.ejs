<div class="rounded-tl-3xl shadow-md border p-5 h-[100%] bg-white">
  <div class="mb-6 px-6">
    <h1 class="text-xl font-bold my-1 text-right">
      <%= post ? "تعديل مدونة" : "إضافة مدونة" %>
    </h1>
    <p class="text-gray-600 text-right">
      <a href="/dashboard/posts" class="hover:text-sky-950 hover:font-medium">  مقالات المدونة  </a> &gt; 
      <%= post ? "تعديل مدونة" : "إضافة مدونة" %>
    </p>
  </div>

  <form action="<%= post ? '/dashboard/posts/' + post._id + '?_method=PUT' : '/dashboard/posts' %>" method="POST">

    <div class="bg-white rounded-lg px-6 py-2 space-y-6">

     <!-- داخل الفورم -->
<!-- Blog -->
<div>
  <label class="block text-right mb-2 required font-medium">المدونة</label>
  <select name="blog" id="blogSelect"
          class="w-full p-2 border rounded-md text-right focus:outline-blue-950 focus:outline-1">
    <option value="">اختر مدونة</option>
    <% blogs.forEach(b => { %>
      <option value="<%= b._id %>" <%= post && post.blog.equals(b._id) ? 'selected' : '' %>>
        <%= b.blog %>
      </option>
    <% }) %>
  </select>
  <p id="blogError" class="text-red-500 text-sm mt-1 hidden"></p>
</div>

<!-- Name -->
<div>
  <label class="block text-right mb-2 required font-medium">اسم المدونة</label>
  <input type="text" name="name" id="nameInput"
         class="w-full p-2 border rounded-md text-right focus:outline-blue-950 focus:outline-1"
         placeholder="اسم المدونة"
         value="<%= post?.name || '' %>">
  <p id="nameError" class="text-red-500 text-sm mt-1 hidden"></p>
</div>

<!-- Permanent Link -->
<div>
  <label class="block text-right mb-2 required font-medium">الرابط الدائم</label>
  <input type="text" name="permaLink" id="permaLinkInput"
         class="w-full p-2 border rounded-md text-right focus:outline-blue-950 focus:outline-1"
         placeholder="Permanent Link"
         value="<%= post?.permaLink || '' %>">
  <p id="permaLinkError" class="text-red-500 text-sm mt-1 hidden"></p>
  <% if (typeof error !== 'undefined') { %>
    <div class="text-red-500 text-sm mt-1 text-right font-medium" role="alert">
      <strong class="font-bold">خطأ:</strong>
      <span class="block sm:inline">
        <% if (error.includes("E11000") && error.includes("permaLink")) { %>
          الرابط الدائم موجود بالفعل، من فضلك اكتب رابط آخر.
        <% } else { %>
          <%= error %>
        <% } %>
      </span>
    </div>
  <% } %>
</div>

<!-- Title -->
<div>
  <label class="block text-right mb-2 required font-medium">العنوان</label>
  <input type="text" name="title" id="titleInput"
         class="w-full p-2 border rounded-md text-right focus:outline-blue-950 focus:outline-1"
         placeholder="Post Title"
         value="<%= post?.title || '' %>">
  <p id="titleError" class="text-red-500 text-sm mt-1 hidden"></p>
</div>

<!-- Content -->
<div>
  <label class="block text-right mb-2 required font-medium">الوصف</label>
  <div id="editor-container" dir="rtl" class="quill-container border rounded-md">
    <%- post?.content || '' %>
  </div>
  <input type="hidden" name="content" id="content">
  <p id="contentError" class="text-red-500 text-sm mt-1 hidden"></p>
</div>


      <!-- Buttons -->
      <div class="flex justify-between mt-10">
        <button type="submit"
                class="bg-gray-400 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-md w-[45%] text-center flex items-center justify-center">
          <i class="fa-regular fa-square-check me-2"></i><%= post ? "تحديث" : "حفظ" %>
        </button>
        <a href="/dashboard/posts"
           class="bg-white border border-gray-700 hover:bg-gray-700 hover:text-white text-gray-800 font-bold py-3 px-4 rounded-md flex items-center justify-center w-[45%]">
          رجوع <i class="fa-solid fa-arrow-left ms-2"></i>
        </a>
      </div>
    </div>
  </form>
</div>

<!-- Quill CSS & JS -->
<link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>

<script>
  const editor = new Quill('#editor-container', {
    theme: 'snow',
    placeholder: 'اكتب المحتوى هنا...',
    modules: {
      toolbar: [
        [{ header: [1, 2, 3, false] }],
        ['bold', 'italic', 'underline', 'strike'],
        [{ 'color': [] }, { 'background': [] }],
        ['link', 'image', 'blockquote', 'code-block'],
        [{ list: 'ordered' }, { list: 'bullet' }],
        [{ align: [] }],
        ['clean']
      ]
    }
  });

  const form = document.querySelector('form');

  function showError(id, message) {
    const el = document.getElementById(id);
    el.textContent = message;
    el.classList.remove('hidden');
  }

  function hideError(id) {
    const el = document.getElementById(id);
    el.textContent = '';
    el.classList.add('hidden');
  }

  form.onsubmit = (e) => {
    let isValid = true;

    // Reset errors
    ['blogError', 'nameError', 'permaLinkError', 'titleError', 'contentError'].forEach(hideError);

    // Blog
    if (!document.getElementById('blogSelect').value) {
      showError('blogError', 'يجب اختيار مدونة.');
      isValid = false;
    }

    // Name
    const name = document.getElementById('nameInput').value.trim();
    if (!name) {
      showError('nameError', 'الاسم مطلوب.');
      isValid = false;
    } else if (name.length < 3) {
      showError('nameError', 'الاسم يجب أن يكون على الأقل 3 أحرف.');
      isValid = false;
    }

    // permaLink
    const permaLink = document.getElementById('permaLinkInput').value.trim();
    if (!permaLink) {
      showError('permaLinkError', 'الرابط الدائم مطلوب.');
      isValid = false;
    } 
    // Title
    const title = document.getElementById('titleInput').value.trim();
    if (!title) {
      showError('titleError', 'العنوان مطلوب.');
      isValid = false;
    } else if (title.length < 3) {
      showError('titleError', 'العنوان يجب أن يكون على الأقل 3 أحرف.');
      isValid = false;
    }

    // Content
    const content = editor.root.innerHTML.trim();
    const plainText = editor.getText().trim();
    document.querySelector('#content').value = content;
    if (!plainText) {
      showError('contentError', 'الوصف مطلوب.');
      isValid = false;
    } else if (plainText.length < 5) {
      showError('contentError', 'الوصف يجب أن يكون على الأقل 5 حرفاً.');
      isValid = false;
    }

    if (!isValid) {
      e.preventDefault();
    }
  };
</script>


<style>
  .quill-container {
    height: 200px;
  }
  .ql-editor {
    direction: rtl !important;
    text-align: right !important;
  }
  .required::after {
    content: " *";
    color: red;
  }
</style>
